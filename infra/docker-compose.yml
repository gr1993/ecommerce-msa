x-service-common: &service-common
  privileged: true
  networks:
    - ecommerce-net
  environment: &service-common-env
    MYSQL_HOST: mysql8
    KAFKA_BOOTSTRAP_SERVERS: kafka1:9091,kafka2:9092,kafka3:9094
    ELASTICSEARCH_HOST: elasticsearch
    REDIS_HOST: redis
    CONFIG_HOST: config-server
    EUREKA_HOST: discovery-service

x-healthcheck-template: &healthcheck-template
  interval: 10s
  timeout: 5s
  retries: 5
  start_period: 10s

x-depends-on-infra: &depends-on-infra
  config-server:
    condition: service_healthy
  discovery-service:
    condition: service_healthy

services:
  config-server:
    <<: *service-common
    container_name: config-server
    build: ../service/config-server
    ports:
      - "8888:8888"
    healthcheck:
      <<: *healthcheck-template
      test: ["CMD-SHELL", "nc -z localhost 8888 || exit 1"]

  discovery-service:
    <<: *service-common
    container_name: discovery-service
    build: ../service/discovery-service
    ports:
      - "8761:8761"
    healthcheck:
      <<: *healthcheck-template
      test: ["CMD-SHELL", "nc -z localhost 8761 || exit 1"]

  gateway-service:
    <<: *service-common
    container_name: gateway-service
    build: ../service/gateway-service
    ports:
      - "8080:8080"
    environment:
      <<: *service-common-env
    depends_on: *depends-on-infra

  auth-service:
    <<: *service-common
    container_name: auth-service
    build: ../service/auth-service
    ports:
      - "8081:8080"
    environment:
      <<: *service-common-env
    depends_on: *depends-on-infra

  user-service:
    <<: *service-common
    container_name: user-service
    build: ../service/user-service
    ports:
      - "8082:8080"
    environment:
      <<: *service-common-env
    depends_on: *depends-on-infra

  product-service:
    <<: *service-common
    container_name: product-service
    build: ../service/product-service
    ports:
      - "8083:8080"
    environment:
      <<: *service-common-env
    depends_on: *depends-on-infra

  catalog-service:
    <<: *service-common
    container_name: catalog-service
    build: ../service/catalog-service
    ports:
      - "8084:8080"
    environment:
      <<: *service-common-env
    depends_on: *depends-on-infra


networks:
  ecommerce-net:
    external: true